# Spike DynamoDB Toolbox for typing

## Getting started

```bash
# Install, bootstrap and run
$ pnpm install
$ pnpm bootstrap
$ pnpm start
Restarting 'src/main.ts'
Roles: {
  '$metadata': {
    httpStatusCode: 200,
    requestId: '2809366c-04ca-4fa4-87b1-783dedee3f96',
    extendedRequestId: undefined,
    cfId: undefined,
    attempts: 1,
    totalRetryDelay: 0
  },
  Count: 10,
  Items: [
    {
      created: '2024-03-06T01:05:49.358Z',
      composite_id: 'Role#890c90b6-6813-469e-a757-8f713bd33226',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.358Z',
      name: 'fIyGcrXZHb',
      description: '5qaFMmsxLV',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: 'fiygcrxzhb',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.358Z',
      composite_id: 'Role#a8c00761-a1bd-42c5-bcbf-38284fe5bf57',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.358Z',
      name: '44FV8UbdrI',
      description: 'Ito4IoDPdE',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: '44fv8ubdri',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.357Z',
      composite_id: 'Role#13b14ba2-ac19-42a8-a821-bead56fafb85',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.358Z',
      name: 'dyfdQ6g7vG',
      description: 'zYdvwfUYjT',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: 'dyfdq6g7vg',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.359Z',
      composite_id: 'Role#a6a545cd-7110-47b8-9281-4a105dcc6502',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.359Z',
      name: 'DmEKyYvm4w',
      description: 'T6Rm7PE5uy',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: 'dmekyyvm4w',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.359Z',
      composite_id: 'Role#d85881e9-65a4-499f-8711-e3a2ca3fc340',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.359Z',
      name: 'qPS2MB4uM1',
      description: 'knjMd189Om',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: 'qps2mb4um1',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.359Z',
      composite_id: 'Role#d64023b5-61e1-485b-9af4-f3a774ce0e40',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.359Z',
      name: 'BsTo2bJnpJ',
      description: 'z69ruepL6t',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: 'bsto2bjnpj',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.359Z',
      composite_id: 'Role#93534ec5-f7a3-45db-b899-5b47ba22cb6e',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.359Z',
      name: 'HQKSKST5s1',
      description: '2KdvkWancg',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: 'hqkskst5s1',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.359Z',
      composite_id: 'Role#6b9606f3-ed48-4b14-ba33-40fc9de68dde',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.359Z',
      name: '4jYPZN1GQ9',
      description: 'cIAQMrKlDg',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: '4jypzn1gq9',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.359Z',
      composite_id: 'Role#e2545b03-c3b6-40bd-83cf-b576cd9793da',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.359Z',
      name: 'LcBEJFtS1V',
      description: 'D4dLtUSNbq',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: 'lcbejfts1v',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    },
    {
      created: '2024-03-06T01:05:49.359Z',
      composite_id: 'Role#71f8b1db-3d68-424d-9da8-90d6d1323aa7',
      permissions: [Array],
      modified: '2024-03-06T01:05:49.359Z',
      name: '6PL1mWg7Ro',
      description: 'bR1t3EcwEq',
      sort_key: 'PartyType#Merchant#PartyId#123',
      lowercaseName: '6pl1mwg7ro',
      gsi_pk_1: 'PartyType#Merchant#PartyId#123',
      entity: 'Role'
    }
  ],
  LastEvaluatedKey: {
    composite_id: 'Role#71f8b1db-3d68-424d-9da8-90d6d1323aa7',
    sort_key: 'PartyType#Merchant#PartyId#123',
    gsi_pk_1: 'PartyType#Merchant#PartyId#123',
    _md: '2024-03-06T01:05:49.359Z'
  },
  ScannedCount: 10,
  next: [Function: next]
}
Completed running 'src/main.ts'
```

## Overview

This spike looks to use [DynamoDB Toolbox](https://www.dynamodbtoolbox.com/) to see if we can get a better approach to tightly coupling types to our DynamoDB usage.

The general gist of it:

1. Define the full entities types (right now, without any nullish values).
2. Use the attributes of those entities to enforce type safety on our `Table` declaration for DynamoDB Toolbox.
3. Derive our table + GSI primary keys from the source-of-truth entity declaration.
4. Create each entity using generics for the type ["overlays"](https://www.dynamodbtoolbox.com/docs/type-inference#overlays) for DynamoDB Toolbox.
5. Similar to what we did for part (2), we also enforce _some form_ of moderate type safety for the `attributes` record using `satisfies` to at least ensure the keys are happy.
6. When now using the `Entity` class instance, there will be enforced type safety.

## Trade-offs

- The obvious downside is moving away from AWS SDK, which in earnest is probably the desired way to use this.
- We rely a lot on ["overlays"](https://www.dynamodbtoolbox.com/docs/type-inference#overlays) or `satisfies` in order to enforce correct typing within the `Table` and `Entity` class arguments.

## Alternatives

Something that I came across that seems useful but underutilized is the `translateConfig` for `DynamoDBDocumentClient` (which is not part of DynamoDB Toolbox). Maybe we can still use some of it.

We should probably decide what our contracts return to e.g. `data: {}, nextKey: {}` etc.

Finally, even if it's not enforcing tight coupling with our DynamoDB database, we could just pull up all the types into one library and enforce them as the source of truth for the types across the packages. In earnest, I think this would be better done through a custom, internally use package that queries our services.
